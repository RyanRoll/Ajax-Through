/** ==================================================================================================== **
 *
 *	AJAX-Throught Small Version ( Action-work version ) 1.0.0
 *
 *	http://at.antslab.tw/
 *
 *	CopyLeft (c)  Roll 2011.07
 *
** ==================================================================================================== **/
(function(){AT={};var l,m,n,o,p,e={};e.extend=function(a,b,c){if(e.isObject(a)){var d=e.clone(a,c),a=function(){};a.prototype=d}if(e.isObject(b))var f=b,b=function(){};else b=b||function(){};d=function(){};d.prototype=e.clone(a.prototype,c);b.prototype=new d;f&&e.override(b.prototype,f);b.prototype.constructor=b;b.superclass=a.prototype;b.prototype.superclass=a;if(a.prototype.constructor==Object.prototype.constructor)a.prototype.constructor=a;return b};e.extendPrototype=function(a,b,c,d){a=e.clone(a,d);c&&e.extendPrototype(a,c);return e.override(a,b)};e.override=function(a,b,c,d){if(c)for(var f in b)f in a||(a[f]=e.isObject(b[f])?e.clone(b[f]):b[f]);else for(f in b)a[f]=d&&e.isObject(b[f])?e.clone(b[f]):b[f];return a};e.addPrivateProperty=function(a,b,c){var c=c||"_",d;for(d in b)a[c+d]=b[d];return a};e.clone=function(a,b){return e.override({},a,b)};e.isFunction=function(a){try{return/^\s*\bfunction\b/.test(a)}catch(b){return!1}};e.isNumber=function(a){return typeof a==="number"&&isFinite(a)};e.isString=function(a){return typeof a==="string"};e.isObject=function(a){return!!a&&(typeof a==="object"||Object.prototype.toString.call(a)==="[object Object]")};e.isjQuery=function(a){return!!a&&a instanceof jQuery};e.isArray=function(a){return a instanceof Array||Object.prototype.toString.apply(a)==="[object Array]"};e.isATPage=function(a){if(e.isFunction(a))return!!a._isPage};e.setFnScope=function(){var a=arguments;switch(a.length){case 3:return function(){return a[0][a[1]].apply(a[2],arguments)};case 2:return e.isFunction(a[0])?function(){return a[0].apply(a[1],arguments)}:function(){return a[0][a[1]].apply(a[0],arguments)};case 1:return function(){return a[0].apply(a[0],arguments)};default:return AT.SEP.show(" Fn:apply error"),null}};e.GETStringToObj=function(a){if(e.isString(a)){for(var b={},a=a.split("&"),c=a.length,c=a[c-1]?c:--c,d=0;d<c;d++){var f=a[d].split("=");if(f.length==2)b[f[0]]=f[1];else break}return b}return a};e.objectToGETString=function(a){if(e.isObject(a)){var b="",c;for(c in a)c!="remove"&&c!="indexOf"&&(b+=c+"="+a[c]+"&");return b.substr(0,b.length-1)}else return a};e.stringEqual=function(a,b){return AT.Fn.isString(a)&&AT.Fn.isString(b)?a.toUpperCase()===b.toUpperCase():!1};l=function(){this.print=function(){for(var a=[],b=0;b<arguments.length;b++)AT.Fn.isObject(arguments[b])?a.push(this.objToString(arguments[b])):AT.Fn.isArray(arguments[b])?a.push(arguments[b].toString()):a.push(arguments[b]);alert(a.join(" ,\n"))};this.printObj=function(a){alert(this.objToString(a))};this.printVar=function(){alert(this.argToArray(arguments).join(" , "))};this.jsonToString=JSON.stringify;this.argToArray=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return b};this.objToString=function(a){var b=[],c;for(c in a)b.push(c+" : "+(AT.Fn.isObject(a[c])?this.objToString(a[c]):a[c]));return a+" = {\n\t"+b.join(",\n\t")+"\n}"};this.printAttr=function(a){var b=[],c;for(c in a)b.push(c);alert(b.join(", "))}};m=function(){this.Class={};this.Objects={};this.register=function(a,b){this.Class[a]=b;AT.isInit()&&this.add(a)};this.init=function(a){this.reference=a;for(var b in this.Class)this.add(b)};this.add=function(a){var b=AT.Fn.extend(this.reference,this.Class[a],!0);b.prototype._name_=a;this.Objects[a]=new b};this.isProperty=function(a,b){try{return b in this.Objects[a]}catch(c){return!1}};this.get=function(a){return this.Objects[a]};this.isSet=function(a){return a in this.Class}};n=e.extend({fireAppletEvent:function(a,b,c,d){if(a.setting.events[b])return a.setting.events[b](c,d)},fireMethodEvent:function(a,b,c,d,f){var g=a[b].overrideEvent,b=a[b].events,e=void 0,h=void 0;if(g===!1||g===void 0&&(!b||!b[c]))g=a.setting.events,g.method&&g.method[c]&&(e=g.method[c].call(a,d,f));b&&b[c]&&(h=b[c].call(a,d,f));return e===!1||h===!1},interruptThru:function(a){this.unMaskView();delete a.__callback__;return null},unMaskView:function(){}},function(a){var b=this;this.Coll=new m;$("*[at-action]").live("click",function(a){a.preventDefault();var a=$(this),d=a.attr("at-action");b.thru(a,d)});this.splitCode=function(a){var b=a.match(/^(\w+)\.(\w+)(\(['"-\., \w]*\))?$/);if(b)return b[3]?(a=b[3].substr(1,b[3].length-2).split(","),b[3]=this.getArguments(a)):b[3]=[],{cmd:b[0],name:b[1],method:b[2],args:b[3]};else AT.SEP.show("system","Action: fire Action Error! \u300c"+a+"\u300d")};this.getArguments=function(a){for(var b=0;b<a.length;b++){var f=a[b],g=f.match(/^\'([^"]*)\'$/);g?a[b]=g[1]:/^(\-)?([0-9]+)(\.?([0-9]+))?$/.test(f)?a[b]=parseInt(f,10):(g=f.match(/^\"([^"]*)\"$/),a[b]=g?g[1]:eval(f))}return a};this.getFormParams=function(a){var b={},a=a.parent("form");a.size()>0&&$("*[name]",a).each(function(){var a=$(this);b[a.attr("name")]=a.val()});return b};this.thru=function(b,d){var d=this.splitCode(d),f=d.name,g=d.method,e=d.args,h=f.toLowerCase();this.Coll.isSet(f)?this._runThru(b,d,f,g,e,h):a.requireResource({name:h,scope:this,callback:function(){this._runThru(b,d,f,g,e,h)}})};this._runThru=function(a,d,f,g,e,h){var i=this.Coll.get(f);if(!i)return AT.SEP.show("action","can't find the Action ["+f+"]"),null;a.parent("form");var j=this.getFormParams(a),k=[j,a].concat(e),k=i[g]._sendFn_.apply(i,k);if(k===!1)return null;else AT.Fn.isObject(k)&&(j=k);k=AT.Fn.clone(j);return $.ajax({url:AT.getServerUrl()+h+"/"+g+"/",type:"POST",data:AT.Fn.objectToGETString(k)||"",success:function(h){if(!AT.Fn.isObject(h))return AT.SEP.show("action-ajax"," ajax failure "),null;if(h.error)AT.SEP.show("Action-"+f+" error:",h.error+"\u932f\u8aa4: "+h.msg);else{if(b.fireMethodEvent(i,g,"afterAjax",d,j))return b.interruptThru(d);h=[h,j,a].concat(e);if(b.fireMethodEvent(i,g,"beforeShow",d,j))return b.interruptThru(d);i[g].apply(i,h);b.fireMethodEvent(i,g,"show",d,j);b.fireMethodEvent(i,g,"end",d,j)}},error:function(a){a.status!==0&&AT.SEP.show("ajax"," ajax failure ")}})}});o=function(){function a(a,c,d){for(var f="",e=0,q=a.length;e<q;e++)f+=a[e]+";";d&&(f="(function(){ "+f+" })();");$(document.body).append("<"+c+">"+f+"</"+c+">")}this.requireResource=function(b){var c=b.name,d=b.callback||function(){},e=b.scope||window;$.ajax({url:AT.getServerUrl()+"require/",type:"POST",data:"AT_rRequest="+c,success:function(b){b.AT_rResponse?(b=b.AT_rResponse,b.js&&a(b.js,"script",!0),b.css&&a(b.css,"style"),d.apply(e)):AT.SEP.show("RLoader"," load "+c+" resources failure ")},error:function(a){a.status!==0&&AT.SEP.show("RLoader"," ajax failure ")}})}};p=function(){this.destroy=function(a,b){if(b)if(AT.Fn.isArray(b))for(var c=0;c<b.length;c++)this.destroyIfIsSetting(b[c]);else if(b.Comps)if(AT.Fn.isArray(b.Comps))for(var c=0,d=b.Comps.length;c<d;c++)this.destroyIfIsSetting(b.Comps[c]);else this.destroyIfIsSetting(b);else b.apply(a)};this.destroyIfIsSetting=function(a){this.execDestroy(a.Comps);a.fn&&(a.scope?a.fn.apply(a.scope):a.fn())};this.execDestroy=function(a){if(AT.Fn.isObject(a))this.doDestroy(a);else if(AT.Fn.isArray(a))for(var b=0;b<a.length;b++)this.doDestroy(a[b])};this.doDestroy=function(a){for(var b in a)a[b]&&(AT.Fn.isjQuery(a[b])?a[b].remove():"destroy"in a[b]&&(AT.Fn.isFunction(a[b].destroy)?a[b].destroy():this.destroyIfIsSetting(a[b].destroy)),a[b]=null)}};var r=function(a){this.show=function(a,c){arguments.length==1&&(c=a,a="system");this.render(a,"System Error: "+c)};this.render=function(b,c){if(a.ErrorApp){var d=AT.Fn.clone(a.ErrorApp);d.variables=[b,c].concat(d);d.endFn=function(){d.endFn&&(d.endFn(),d=null)};AT.thru(a.ErrorApp)}else alert(c)}};AT=new function(){var a=!1,b={INITDATA:null,SERVERURL:null};this.Fn=e;this.Class={};var c=function(){};c.prototype={setting:{Comps:{},events:{},errors:null,destroy:null},_name_:""};var d=new o,f=new n(d);new p;this.Debug=new l;this.SEP=new r(b);this.Action=function(a,b,c){c=c||{};c.isAction=!0;c._sendFn_=a;return AT.Fn.override(b,c)};this.getServerUrl=function(){return b.SERVERURL};this.isInit=function(){return a};this.register=this.Fn.setFnScope(f.Coll,"register");this.init=function(d){if(d||!a)a=!0,b.INITDATA=d.initData?AT.Fn.clone(d.initData):b.INITDATA,b.SERVERURL=d.serverUrl||b.INITDATA.serverUrl,b.SERVERURL||AT.SEP.show(" client/server url Not Found "),f.Coll.init(c),delete this.init}}})();